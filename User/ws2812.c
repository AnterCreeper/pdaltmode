#include "ws2812.h"
#include "timer.h"

void WS2812_INIT() {
    WS2812_GPIO_INIT();
    GPIO_OUT_INIT(WS2812_PORT, WS2812_PIN, Bit_RESET);
    return;
}

static inline void __WS2812_0() {
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    return;
}

static inline void __WS2812_1() {
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BSHR = WS2812_PIN;
    WS2812_PORT->BCR = WS2812_PIN;
    return;
}

void WS2812_SetColor(int32_t grb) {
    __disable_irq();
    grb <<= 8;
    for(int i = 0; i < 24; i++) {
        if(grb < 0) __WS2812_1();
        else __WS2812_0();
        grb <<= 1;
    }
    __enable_irq();
    TIM_Delay_Us(300); //RST
    return;
}